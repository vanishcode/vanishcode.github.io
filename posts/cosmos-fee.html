<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><link rel="preload" as="font" href="/_next/static/media/e4af272ccee01ff0-s.p.woff2" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/9152c37d2d6aee8c.css" data-precedence="next"/><title>Cosmos &amp; Keplr 手续费调研</title><meta name="description" content="调研 keplr 插件钱包费用选择/设置组件的实现 👛"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="any"/><meta name="next-size-adjust"/><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" noModule=""></script></head><body class="antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 __className_52d07b"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="max-w-2xl mx-auto py-10 px-4"><header><div class="flex items-center justify-between"><button class="border rounded-md w-6 h-6 flex items-center justify-center"><span class="sr-only">Toggle mode</span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"></path></svg></button><nav class="ml-auto text-sm font-medium space-x-6"><a href="/">Home</a><a href="/about">About</a></nav></div></header><main><article class="py-6 prose dark:prose-invert"><h1 class="mb-2">Cosmos &amp; Keplr 手续费调研</h1><p class="text-xl mt-0 text-slate-700 dark:text-slate-200">调研 keplr 插件钱包费用选择/设置组件的实现 👛</p><hr class="my-4"/><blockquote>
<p>调研 keplr 插件钱包的实现
https://github.com/chainapsis/keplr-wallet
https://chrome.google.com/webstore/detail/dmkamcknogkgcdfhhbddcghachkejeap</p>
</blockquote>
<h1>手续费</h1>
<h2>Fee</h2>
<h3>公式</h3>
<p>fee = gasPrice * gasAmount  例如：</p>
<ul>
<li>0.002585 = 0.03 * 86142</li>
<li>66263 * 1.3 = 86142</li>
</ul>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/fcef851c-0bb3-4a39-9170-29f70b0f7cda" alt="1280X1280"/></p>
<h2>Gas Price</h2>
<h3>默认值</h3>
<p>有最小兜底，以及每条链都配置了默认的 gas price 值（注意这里并不是最小单位）
<img src="https://github.com/vanishcode/Blog/assets/20496444/e1aaff00-75e1-4a1d-b4a1-13a231e0cc3f" alt="1280X1280 (1)"/></p>
<h3>代码</h3>
<p>https://github.com/chainapsis/keplr-wallet/blob/c3ca3a8f29d3a04c334b3d4b696b8c7ed1a48806/packages/extension/src/config.ts#L1180</p>
<h3>远端配置</h3>
<p>都在这个仓库里
举例：https://github.com/chainapsis/keplr-chain-registry/blob/main/cosmos/injective.json</p>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/63b5475e-cf92-402c-b6b9-754fd127c890" alt="a580fda2-e838-4a38-b4b9-de0248eea6d9"/>
<img src="https://github.com/vanishcode/Blog/assets/20496444/d0084883-c2a5-4a92-8746-94f91e67b6fb" alt="a580fda2-e838-4a38-b4b9-de0248eea6d9"/></p>
<h2>Gas Amount</h2>
<h3>值设置</h3>
<p>可以是数量或者倍数，有默认值，填完发送地址和额度显示预估值
<img src="https://github.com/vanishcode/Blog/assets/20496444/2fce2de4-50c4-4761-b1cb-01a7eba85bb6" alt="1f320bc9-a366-46ba-a360-95b1fab93d86"/>
<img src="https://github.com/vanishcode/Blog/assets/20496444/79e9e57f-d3ee-4a56-9d26-9e919daaa45f" alt="fa744436-f956-467e-a917-debf747c161d"/></p>
<p>代码中有些地方也设置了默认值，不同链不一样。接口有问题的时候会用默认值。（但是这些默认配置也会更新，根据 github 上配的 chain info，更新频率很低）</p>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/9341e600-f4ee-4a44-b329-ed0a055a7274" alt="9c3e0b76-c1f5-4776-95e4-6b7e3fa7d3b1"/></p>
<h3>放大倍数</h3>
<p>Gas Adjustment 代码中默认设置 1.3</p>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/9f4670dd-4476-4d96-9f3c-f015184d435c" alt="feb7a7e5-8474-47f2-98bf-63ff7d48f415"/></p>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/4335e920-d8cd-48e5-913d-176c66f377ff" alt="8f26c1bf-1ddb-48d0-9f0b-e6325a3f5e17"/></p>
<p><strong>注意 ⚠️ 这里的值是预执行返回的 gas amount 然后乘这个 1.3 系数（因为可能有小数，因此要取整，如 2.25 要等于 2.3，不能取 2.2，会不够）</strong>
<img src="https://github.com/vanishcode/Blog/assets/20496444/fbc4d952-2208-4003-9496-23d8116801bd" alt="e6a4f9df-46bf-4c57-97aa-6ab7275ad5a2"/></p>
<p>但是，这个放大值只允许在 0 和 2 之间</p>
<p><img src="https://github.com/vanishcode/Blog/assets/20496444/b009ac91-04d3-4f71-805d-e0ff9092471b" alt="bd1b77cd-b206-4bab-b33e-701367a86aa5"/></p>
<h1>预估</h1>
<h2>预执行交易数据格式</h2>
<p>并不需要签名，将交易信息传过来，签名部分搞一个空的参数即可
https://github.com/chainapsis/keplr-wallet/blob/244dc1930ae92ff5afcc0a7f079d35a0c774af6a/packages/stores/src/account/cosmos.ts#L711</p>
<pre><code class="language-js"> const unsignedTx = TxRaw.encode({
  bodyBytes: TxBody.encode(
    TxBody.fromPartial({
    // 这里是交易信息
      messages: msgs,
      memo: memo,
    })
  ).finish(),
  authInfoBytes: AuthInfo.encode({
    signerInfos: [
      SignerInfo.fromPartial({
        // Pub key is ignored.
        // It is fine to ignore the pub key when simulating tx.
        // However, the estimated gas would be slightly smaller because tx size doesn&#x27;t include pub key.
        modeInfo: {
          single: {
            mode: SignMode.SIGN_MODE_LEGACY_AMINO_JSON,
          },
          multi: undefined,
        },
        sequence: account.getSequence().toString(), // 这里需要按照实际传
      }),
    ],
    fee: Fee.fromPartial({
      amount: fee.amount.map((amount) =&gt; {
        return { amount: amount.amount, denom: amount.denom };  // 这里不能为空，但是取之前的接口给的默认值就行
      }),
    }),
  }).finish(),
  // Because of the validation of tx itself, the signature must exist.
  // However, since they do not actually verify the signature, it is okay to use any value.
  // 搞个空的 array buffer 就可以，因为用不到
  signatures: [new Uint8Array(64)],
}).finish();
</code></pre>
<h2>预执行交易数据组装</h2>
<pre><code class="language-js">// 质押
messages: [
  {
    typeUrl: &#x27;/cosmos.staking.v1beta1.MsgDelegate&#x27;,
    value: MsgDelegate.encode({
      delegatorAddress:
        &#x27;celestia1u6lts9ng4etxj0zdaxsada6zgl8dudpgqweugr&#x27;,
      validatorAddress:
        &#x27;celestiavaloper1v5hrqlv8dqgzvy0pwzqzg0gxy899rm4klzxm07&#x27;,
      amount: Coin.fromPartial({ denom: &#x27;utia&#x27;, amount: &#x27;100000&#x27; }),
    }).finish(),
  },
],
</code></pre>
<pre><code class="language-js">// 普通发币        
messages: [
  {
    typeUrl: &#x27;/cosmos.bank.v1beta1.MsgSend&#x27;,
    value: MsgSend.encode({
      fromAddress: from,
      toAddress: to,
      amount: [
        {
          denom,
          amount,
        },
      ],
    }).finish(),
  },
],
</code></pre>
<p><strong>其他消息类型类似，通过对应的消息类型编码为 uint8array 格式。如：https://github.com/osmosis-labs/osmosis-frontend/blob/8d636982aeaf50593cd97f6c37c916062dbd0cde/packages/proto-codecs/src/codegen/osmosis/poolmanager/v1beta1/tx.amino.ts</strong></p>
<h2>插件钱包 API 与手续费预估</h2>
<p>而普通的 JSON / amino 格式，除非知道特定的消息的结构，也就是 encode 的对象，才能转换为 uint8 格式，因此，市面上绝大多数钱包，对于调用 signAmino 方法的交易，直接使用 JSON 数据里的手续费，不做校验和替换</p>
<ul>
<li>signAmino 签名 JSON 格式交易数据：使用较少，是历史遗留方法，目前 osmosis 官方 DApp 在用，但是他们会用自己的费用数据（设置 preferNoSetFee）所以并不需要预估</li>
<li>signDirect 签名 Uint8Array 格式交易数据：使用较多，是新方法，新 DApp 基本都为此方法</li>
</ul>
<p>关于格式转换可以从此 pr 入手了解：
https://github.com/okx/js-wallet-sdk/pull/96</p>
<h2>接口调用</h2>
<p>带假 signatures 的交易的 base64 格式串：</p>
<pre><code class="language-js">const result = await simpleFetch&lt;any&gt;(
  this.chainGetter.getChain(this.chainId).rest,
  &quot;/cosmos/tx/v1beta1/simulate&quot;,
  {
    method: &quot;POST&quot;,
    headers: {
      &quot;content-type&quot;: &quot;application/json&quot;,
    },
    body: JSON.stringify({
      tx_bytes: Buffer.from(unsignedTx).toString(&quot;base64&quot;),
    }),
  }
);

const gasUsed = parseInt(result.data.gas_info.gas_used);
if (Number.isNaN(gasUsed)) {
  throw new Error(`Invalid integer gas: ${result.data.gas_info.gas_used}`);
}
</code></pre>
<p>Curl 调用例子：</p>
<pre><code class="language-shell">curl &#x27;https://lcd-cosmoshub.keplr.app/cosmos/tx/v1beta1/simulate&#x27; \
  -H &#x27;authority: lcd-cosmoshub.keplr.app&#x27; \
  -H &#x27;accept: application/json, text/plain, */*&#x27; \
  -H &#x27;cache-control: no-cache&#x27; \
  -H &#x27;content-type: application/json&#x27; \
  -H &#x27;pragma: no-cache&#x27; \
  -H &#x27;sec-ch-ua: &quot;Not_A Brand&quot;;v=&quot;8&quot;, &quot;Chromium&quot;;v=&quot;120&quot;, &quot;Google Chrome&quot;;v=&quot;120&quot;&#x27; \
  -H &#x27;sec-ch-ua-mobile: ?0&#x27; \
  -H &#x27;sec-ch-ua-platform: &quot;macOS&quot;&#x27; \
  -H &#x27;sec-fetch-dest: empty&#x27; \
  -H &#x27;sec-fetch-mode: cors&#x27; \
  -H &#x27;sec-fetch-site: cross-site&#x27; \
  -H &#x27;user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36&#x27; \
  --data-raw &#x27;{&quot;tx_bytes&quot;:&quot;CpEBCo4BChwvY29zbW9zLmJhbmsudjFiZXRhMS5Nc2dTZW5kEm4KLWNvc21vczF1Nmx0czluZzRldHhqMHpkYXhzYWRhNnpnbDhkdWRwZzN5Z3ZqdxItY29zbW9zMWN5NzVrZXVzYTM5Z2Q1OTZrOHMyNHhkMnl4NTVnZ2dhNzU0Z3V4Gg4KBXVhdG9tEgUxMDAwMBIbCggSBAoCCH8YYBIPCg0KBXVhdG9tEgQyMTUzGkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;}&#x27; \
  --compressed
</code></pre>
<p>返回，用到的就是 gas_info 下的 gas_used 字段（然后还要乘 1.3）：</p>
<pre><code class="language-json">{
  &quot;gas_info&quot;: {
    &quot;gas_wanted&quot;: &quot;1300000&quot;,
    &quot;gas_used&quot;: &quot;66263&quot;
  },
  &quot;result&quot;: {
    &quot;data&quot;: &quot;Ch4KHC9jb3Ntb3MuYmFuay52MWJldGExLk1zZ1NlbmQ=&quot;,
    &quot;log&quot;: &quot;[{\&quot;events\&quot;:[{\&quot;type\&quot;:\&quot;coin_received\&quot;,\&quot;attributes\&quot;:[{\&quot;key\&quot;:\&quot;receiver\&quot;,\&quot;value\&quot;:\&quot;cosmos1cy75keusa39gd596k8s24xd2yx55ggga754gux\&quot;},{\&quot;key\&quot;:\&quot;amount\&quot;,\&quot;value\&quot;:\&quot;10000uatom\&quot;}]},{\&quot;type\&quot;:\&quot;coin_spent\&quot;,\&quot;attributes\&quot;:[{\&quot;key\&quot;:\&quot;spender\&quot;,\&quot;value\&quot;:\&quot;cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\&quot;},{\&quot;key\&quot;:\&quot;amount\&quot;,\&quot;value\&quot;:\&quot;10000uatom\&quot;}]},{\&quot;type\&quot;:\&quot;message\&quot;,\&quot;attributes\&quot;:[{\&quot;key\&quot;:\&quot;action\&quot;,\&quot;value\&quot;:\&quot;/cosmos.bank.v1beta1.MsgSend\&quot;},{\&quot;key\&quot;:\&quot;sender\&quot;,\&quot;value\&quot;:\&quot;cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\&quot;},{\&quot;key\&quot;:\&quot;module\&quot;,\&quot;value\&quot;:\&quot;bank\&quot;}]},{\&quot;type\&quot;:\&quot;transfer\&quot;,\&quot;attributes\&quot;:[{\&quot;key\&quot;:\&quot;recipient\&quot;,\&quot;value\&quot;:\&quot;cosmos1cy75keusa39gd596k8s24xd2yx55ggga754gux\&quot;},{\&quot;key\&quot;:\&quot;sender\&quot;,\&quot;value\&quot;:\&quot;cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\&quot;},{\&quot;key\&quot;:\&quot;amount\&quot;,\&quot;value\&quot;:\&quot;10000uatom\&quot;}]}]}]&quot;,
    &quot;events&quot;: [
      {
        &quot;type&quot;: &quot;message&quot;,
        &quot;attributes&quot;: [
          {
            &quot;key&quot;: &quot;YWN0aW9u&quot;,
            &quot;value&quot;: &quot;L2Nvc21vcy5iYW5rLnYxYmV0YTEuTXNnU2VuZA==&quot;,
            &quot;index&quot;: false
          }
        ]
      },
      // ............. 省略
    ]
  }
}
</code></pre>
<p>https://docs.junonetwork.io/developer-guides/api-endpoints/cosmos/tx/v1beta1/simulate
这里有 JUNO 的文档，可以参考</p></article></main></div><script src="/_next/static/chunks/webpack-3a35b39d748bae39.js" async=""></script><script src="/_next/static/chunks/3949d24b-b3670977323a3ac7.js" async=""></script><script src="/_next/static/chunks/604-576b6ce5c58b6c72.js" async=""></script><script src="/_next/static/chunks/main-app-df5321dfc4619866.js" async=""></script></body></html><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/e4af272ccee01ff0-s.p.woff2\",{\"as\":\"font\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/9152c37d2d6aee8c.css\",{\"as\":\"style\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I{\"id\":\"4518\",\"chunks\":[\"272:static/chunks/webpack-3a35b39d748bae39.js\",\"508:static/chunks/3949d24b-b3670977323a3ac7.js\",\"604:static/chunks/604-576b6ce5c58b6c72.js\"],\"name\":\"\",\"async\":false}\n6:I{\"id\":\"6341\",\"chunks\":[\"272:static/chunks/webpack-3a35b39d748bae39.js\",\"508:static/chunks/3949d24b-b3670977323a3ac7.js\",\"604:static/chunks/604-576b6ce5c58b6c72.js\"],\"name\":\"\",\"async\":false}\n7:I{\"id\":\"394\",\"chunks\":[\"485:static/chunks/485-3071997949e00430.js\",\"185:static/chunks/app/layout-0c716af5725e1bc4.js\"],\"name"])</script><script>self.__next_f.push([1,"\":\"ThemeProvider\",\"async\":false}\n8:I{\"id\":\"7749\",\"chunks\":[\"485:static/chunks/485-3071997949e00430.js\",\"185:static/chunks/app/layout-0c716af5725e1bc4.js\"],\"name\":\"ModeToggle\",\"async\":false}\n9:I{\"id\":\"6485\",\"chunks\":[\"485:static/chunks/485-3071997949e00430.js\",\"185:static/chunks/app/layout-0c716af5725e1bc4.js\"],\"name\":\"\",\"async\":false}\na:I{\"id\":\"8900\",\"chunks\":[\"485:static/chunks/485-3071997949e00430.js\",\"185:static/chunks/app/layout-0c716af5725e1bc4.js\"],\"name\":\"Analytics\",\"async\":false}\nb:I{\"id\":\"5813\",\"ch"])</script><script>self.__next_f.push([1,"unks\":[\"272:static/chunks/webpack-3a35b39d748bae39.js\",\"508:static/chunks/3949d24b-b3670977323a3ac7.js\",\"604:static/chunks/604-576b6ce5c58b6c72.js\"],\"name\":\"\",\"async\":false}\nc:I{\"id\":\"8464\",\"chunks\":[\"272:static/chunks/webpack-3a35b39d748bae39.js\",\"508:static/chunks/3949d24b-b3670977323a3ac7.js\",\"604:static/chunks/604-576b6ce5c58b6c72.js\"],\"name\":\"\",\"async\":false}\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/9152c37d2d6aee8c.css\",\"precedence\":\"next\"}]],[\"$\",\"$L4\",null,{\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/cosmos-fee\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"cosmos-fee\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"cosmos-fee\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[\"$L5\",[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\"}]],\"globalErrorComponent\":\"$6\",\"notFound\":[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 __className_52d07b\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"max-w-2xl mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between\",\"children\":[[\"$\",\"$L8\",null,{}],[\"$\",\"nav\",null,{\"className\":\"ml-auto text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L9\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L9\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],[\"$\",\"main\",null,{\"children\":[\"$undefined\",[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]]}]]}],[\"$\",\"$La\",null,{}]]}]}]}],\"asNotFound\":false,\"children\":[[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"antialiased min-h-screen bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-50 __className_52d07b\",\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"defaultTheme\":\"system\",\"enableSystem\":true,\"children\":[[\"$\",\"div\",null,{\"className\":\"max-w-2xl mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between\",\"children\":[[\"$\",\"$L8\",null,{}],[\"$\",\"nav\",null,{\"className\":\"ml-auto text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L9\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L9\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],[\"$\",\"main\",null,{\"children\":[\"$\",\"$Lb\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$Lb\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$\",\"$Lb\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"cosmos-fee\",\"c\"],\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"asNotFound\":false,\"childProp\":{\"current\":[\"$Ld\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"cosmos-fee\\\"]}\"},\"styles\":[]}],\"segment\":[\"slug\",\"cosmos-fee\",\"c\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}]}]]}],[\"$\",\"$La\",null,{}]]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"d:[\"$\",\"article\",null,{\"className\":\"py-6 prose dark:prose-invert\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-2\",\"children\":\"Cosmos \u0026 Keplr 手续费调研\"}],[\"$\",\"p\",null,{\"className\":\"text-xl mt-0 text-slate-700 dark:text-slate-200\",\"children\":\"调研 keplr 插件钱包费用选择/设置组件的实现 👛\"}],[\"$\",\"hr\",null,{\"className\":\"my-4\"}],[[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"调研 keplr 插件钱包的实现\\nhttps://github.com/chainapsis/keplr-wallet\\nhttps://chrome.google.com/webstore/detail/dmkamcknogkgcdfhhbddcghachkejeap\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"手续费\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Fee\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"公式\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"fee = gasPrice * gasAmount  例如：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"0.002585 = 0.03 * 86142\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"66263 * 1.3 = 86142\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/fcef851c-0bb3-4a39-9170-29f70b0f7cda\",\"alt\":\"1280X1280\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Gas Price\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"默认值\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"有最小兜底，以及每条链都配置了默认的 gas price 值（注意这里并不是最小单位）\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/e1aaff00-75e1-4a1d-b4a1-13a231e0cc3f\",\"alt\":\"1280X1280 (1)\"}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"代码\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"https://github.com/chainapsis/keplr-wallet/blob/c3ca3a8f29d3a04c334b3d4b696b8c7ed1a48806/packages/extension/src/config.ts#L1180\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"远端配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"都在这个仓库里\\n举例：https://github.com/chainapsis/keplr-chain-registry/blob/main/cosmos/injective.json\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/63b5475e-cf92-402c-b6b9-754fd127c890\",\"alt\":\"a580fda2-e838-4a38-b4b9-de0248eea6d9\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/d0084883-c2a5-4a92-8746-94f91e67b6fb\",\"alt\":\"a580fda2-e838-4a38-b4b9-de0248eea6d9\"}]]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"Gas Amount\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"值设置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"可以是数量或者倍数，有默认值，填完发送地址和额度显示预估值\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/2fce2de4-50c4-4761-b1cb-01a7eba85bb6\",\"alt\":\"1f320bc9-a366-46ba-a360-95b1fab93d86\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/79e9e57f-d3ee-4a56-9d26-9e919daaa45f\",\"alt\":\"fa744436-f956-467e-a917-debf747c161d\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"代码中有些地方也设置了默认值，不同链不一样。接口有问题的时候会用默认值。（但是这些默认配置也会更新，根据 github 上配的 chain info，更新频率很低）\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/9341e600-f4ee-4a44-b329-ed0a055a7274\",\"alt\":\"9c3e0b76-c1f5-4776-95e4-6b7e3fa7d3b1\"}]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"放大倍数\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Gas Adjustment 代码中默认设置 1.3\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/9f4670dd-4476-4d96-9f3c-f015184d435c\",\"alt\":\"feb7a7e5-8474-47f2-98bf-63ff7d48f415\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/4335e920-d8cd-48e5-913d-176c66f377ff\",\"alt\":\"8f26c1bf-1ddb-48d0-9f0b-e6325a3f5e17\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"注意 ⚠️ 这里的值是预执行返回的 gas amount 然后乘这个 1.3 系数（因为可能有小数，因此要取整，如 2.25 要等于 2.3，不能取 2.2，会不够）\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/fbc4d952-2208-4003-9496-23d8116801bd\",\"alt\":\"e6a4f9df-46bf-4c57-97aa-6ab7275ad5a2\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"但是，这个放大值只允许在 0 和 2 之间\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"https://github.com/vanishcode/Blog/assets/20496444/b009ac91-04d3-4f71-805d-e0ff9092471b\",\"alt\":\"bd1b77cd-b206-4bab-b33e-701367a86aa5\"}]}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"预估\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"预执行交易数据格式\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"并不需要签名，将交易信息传过来，签名部分搞一个空的参数即可\\nhttps://github.com/chainapsis/keplr-wallet/blob/244dc1930ae92ff5afcc0a7f079d35a0c774af6a/packages/stores/src/account/cosmos.ts#L711\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\" const unsignedTx = TxRaw.encode({\\n  bodyBytes: TxBody.encode(\\n    TxBody.fromPartial({\\n    // 这里是交易信息\\n      messages: msgs,\\n      memo: memo,\\n    })\\n  ).finish(),\\n  authInfoBytes: AuthInfo.encode({\\n    signerInfos: [\\n      SignerInfo.fromPartial({\\n        // Pub key is ignored.\\n        // It is fine to ignore the pub key when simulating tx.\\n        // However, the estimated gas would be slightly smaller because tx size doesn't include pub key.\\n        modeInfo: {\\n          single: {\\n            mode: SignMode.SIGN_MODE_LEGACY_AMINO_JSON,\\n          },\\n          multi: undefined,\\n        },\\n        sequence: account.getSequence().toString(), // 这里需要按照实际传\\n      }),\\n    ],\\n    fee: Fee.fromPartial({\\n      amount: fee.amount.map((amount) =\u003e {\\n        return { amount: amount.amount, denom: amount.denom };  // 这里不能为空，但是取之前的接口给的默认值就行\\n      }),\\n    }),\\n  }).finish(),\\n  // Because of the validation of tx itself, the signature must exist.\\n  // However, since they do not actually verify the signature, it is okay to use any value.\\n  // 搞个空的 array buffer 就可以，因为用不到\\n  signatures: [new Uint8Array(64)],\\n}).finish();\\n\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"预执行交易数据组装\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"// 质押\\nmessages: [\\n  {\\n    typeUrl: '/cosmos.staking.v1beta1.MsgDelegate',\\n    value: MsgDelegate.encode({\\n      delegatorAddress:\\n        'celestia1u6lts9ng4etxj0zdaxsada6zgl8dudpgqweugr',\\n      validatorAddress:\\n        'celestiavaloper1v5hrqlv8dqgzvy0pwzqzg0gxy899rm4klzxm07',\\n      amount: Coin.fromPartial({ denom: 'utia', amount: '100000' }),\\n    }).finish(),\\n  },\\n],\\n\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"// 普通发币        \\nmessages: [\\n  {\\n    typeUrl: '/cosmos.bank.v1beta1.MsgSend',\\n    value: MsgSend.encode({\\n      fromAddress: from,\\n      toAddress: to,\\n      amount: [\\n        {\\n          denom,\\n          amount,\\n        },\\n      ],\\n    }).finish(),\\n  },\\n],\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"其他消息类型类似，通过对应的消息类型编码为 uint8array 格式。如：https://github.com/osmosis-labs/osmosis-frontend/blob/8d636982aeaf50593cd97f6c37c916062dbd0cde/packages/proto-codecs/src/codegen/osmosis/poolmanager/v1beta1/tx.amino.ts\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"插件钱包 API 与手续费预估\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"而普通的 JSON / amino 格式，除非知道特定的消息的结构，也就是 encode 的对象，才能转换为 uint8 格式，因此，市面上绝大多数钱包，对于调用 signAmino 方法的交易，直接使用 JSON 数据里的手续费，不做校验和替换\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"signAmino 签名 JSON 格式交易数据：使用较少，是历史遗留方法，目前 osmosis 官方 DApp 在用，但是他们会用自己的费用数据（设置 preferNoSetFee）所以并不需要预估\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"signDirect 签名 Uint8Array 格式交易数据：使用较多，是新方法，新 DApp 基本都为此方法\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"关于格式转换可以从此 pr 入手了解：\\nhttps://github.com/okx/js-wallet-sdk/pull/96\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"接口调用\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"带假 signatures 的交易的 base64 格式串：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"const result = await simpleFetch\u003cany\u003e(\\n  this.chainGetter.getChain(this.chainId).rest,\\n  \\\"/cosmos/tx/v1beta1/simulate\\\",\\n  {\\n    method: \\\"POST\\\",\\n    headers: {\\n      \\\"content-type\\\": \\\"application/json\\\",\\n    },\\n    body: JSON.stringify({\\n      tx_bytes: Buffer.from(unsignedTx).toString(\\\"base64\\\"),\\n    }),\\n  }\\n);\\n\\nconst gasUsed = parseInt(result.data.gas_info.gas_used);\\nif (Number.isNaN(gasUsed)) {\\n  throw new Error(`Invalid integer gas: ${result.data.gas_info.gas_used}`);\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Curl 调用例子：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-shell\",\"children\":\"curl 'https://lcd-cosmoshub.keplr.app/cosmos/tx/v1beta1/simulate' \\\\\\n  -H 'authority: lcd-cosmoshub.keplr.app' \\\\\\n  -H 'accept: application/json, text/plain, */*' \\\\\\n  -H 'cache-control: no-cache' \\\\\\n  -H 'content-type: application/json' \\\\\\n  -H 'pragma: no-cache' \\\\\\n  -H 'sec-ch-ua: \\\"Not_A Brand\\\";v=\\\"8\\\", \\\"Chromium\\\";v=\\\"120\\\", \\\"Google Chrome\\\";v=\\\"120\\\"' \\\\\\n  -H 'sec-ch-ua-mobile: ?0' \\\\\\n  -H 'sec-ch-ua-platform: \\\"macOS\\\"' \\\\\\n  -H 'sec-fetch-dest: empty' \\\\\\n  -H 'sec-fetch-mode: cors' \\\\\\n  -H 'sec-fetch-site: cross-site' \\\\\\n  -H 'user-agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' \\\\\\n  --data-raw '{\\\"tx_bytes\\\":\\\"CpEBCo4BChwvY29zbW9zLmJhbmsudjFiZXRhMS5Nc2dTZW5kEm4KLWNvc21vczF1Nmx0czluZzRldHhqMHpkYXhzYWRhNnpnbDhkdWRwZzN5Z3ZqdxItY29zbW9zMWN5NzVrZXVzYTM5Z2Q1OTZrOHMyNHhkMnl4NTVnZ2dhNzU0Z3V4Gg4KBXVhdG9tEgUxMDAwMBIbCggSBAoCCH8YYBIPCg0KBXVhdG9tEgQyMTUzGkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\"}' \\\\\\n  --compressed\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"返回，用到的就是 gas_info 下的 gas_used 字段（然后还要乘 1.3）：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-json\",\"children\":\"{\\n  \\\"gas_info\\\": {\\n    \\\"gas_wanted\\\": \\\"1300000\\\",\\n    \\\"gas_used\\\": \\\"66263\\\"\\n  },\\n  \\\"result\\\": {\\n    \\\"data\\\": \\\"Ch4KHC9jb3Ntb3MuYmFuay52MWJldGExLk1zZ1NlbmQ=\\\",\\n    \\\"log\\\": \\\"[{\\\\\\\"events\\\\\\\":[{\\\\\\\"type\\\\\\\":\\\\\\\"coin_received\\\\\\\",\\\\\\\"attributes\\\\\\\":[{\\\\\\\"key\\\\\\\":\\\\\\\"receiver\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"cosmos1cy75keusa39gd596k8s24xd2yx55ggga754gux\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"amount\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"10000uatom\\\\\\\"}]},{\\\\\\\"type\\\\\\\":\\\\\\\"coin_spent\\\\\\\",\\\\\\\"attributes\\\\\\\":[{\\\\\\\"key\\\\\\\":\\\\\\\"spender\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"amount\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"10000uatom\\\\\\\"}]},{\\\\\\\"type\\\\\\\":\\\\\\\"message\\\\\\\",\\\\\\\"attributes\\\\\\\":[{\\\\\\\"key\\\\\\\":\\\\\\\"action\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"/cosmos.bank.v1beta1.MsgSend\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"sender\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"module\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"bank\\\\\\\"}]},{\\\\\\\"type\\\\\\\":\\\\\\\"transfer\\\\\\\",\\\\\\\"attributes\\\\\\\":[{\\\\\\\"key\\\\\\\":\\\\\\\"recipient\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"cosmos1cy75keusa39gd596k8s24xd2yx55ggga754gux\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"sender\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"cosmos1u6lts9ng4etxj0zdaxsada6zgl8dudpg3ygvjw\\\\\\\"},{\\\\\\\"key\\\\\\\":\\\\\\\"amount\\\\\\\",\\\\\\\"value\\\\\\\":\\\\\\\"10000uatom\\\\\\\"}]}]}]\\\",\\n    \\\"events\\\": [\\n      {\\n        \\\"type\\\": \\\"message\\\",\\n        \\\"attributes\\\": [\\n          {\\n            \\\"key\\\": \\\"YWN0aW9u\\\",\\n            \\\"value\\\": \\\"L2Nvc21vcy5iYW5rLnYxYmV0YTEuTXNnU2VuZA==\\\",\\n            \\\"index\\\": false\\n          }\\n        ]\\n      },\\n      // ............. 省略\\n    ]\\n  }\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"https://docs.junonetwork.io/developer-guides/api-endpoints/cosmos/tx/v1beta1/simulate\\n这里有 JUNO 的文档，可以参考\"}]]]}]\n"])</script><script>self.__next_f.push([1,"5:[[[\"$\",\"meta\",null,{\"charSet\":\"utf-8\"}],[\"$\",\"title\",null,{\"children\":\"Cosmos \u0026 Keplr 手续费调研\"}],[\"$\",\"meta\",null,{\"name\":\"description\",\"content\":\"调研 keplr 插件钱包费用选择/设置组件的实现 👛\"}],null,null,null,null,null,null,null,null,[\"$\",\"meta\",null,{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],null,null,null,null,null,null,null,null,null,null,[]],[null,null,null,null],null,null,[null,null,null,null,null],null,null,null,null,[null,[[\"$\",\"link\",null,{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"any\"}]],[],null]]\n"])</script>